// region4.js — IF97 Region 4 (Saturation curve)
//
// Units:
//   T → K
//   P → MPa
//
// Design:
//   - Tsat_IF97(P): authoritative IF97 inversion (exact)
//   - Tsat(P): piece-wise quadratic fit (fast, UI)
//   - Psat(T): piece-wise quadratic fit (fast, UI)
//

import { EPS, T_TRIPLE, T_CRIT } from "../constants.js";
import { P_TRIPLE, P_CRIT } from "../constants.js";

/* ============================================================
   Tsat(P) — piece-wise quadratic fit
   P in MPa → T in K
   ============================================================ */

const TsatPieces = [
  { Pmin: 0.000612, Pmax: 0.00192,  a: -5523041.23168, b: 26858.95814, c: 258.79094 },
  { Pmin: 0.00192,  Pmax: 0.006231, a: -573495.57216,  b: 9313.85724,  c: 274.23153 },
  { Pmin: 0.006231, Pmax: 0.017213, a: -74446.55795,  b: 3566.48701,  c: 290.66763 },
  { Pmin: 0.017213, Pmax: 0.041682, a: -12773.94256,  b: 1569.68209,  c: 306.76582 },
  { Pmin: 0.041682, Pmax: 0.090535, a: -2756.71505,   b: 773.87603,   c: 322.53279 },
  { Pmin: 0.090535, Pmax: 0.17964,  a: -719.43479,    b: 418.82759,   c: 337.97835 },
  { Pmin: 0.17964,  Pmax: 0.33045,  a: -219.65162,    b: 244.65929,   c: 353.13768 },
  { Pmin: 0.33045,  Pmax: 0.57026,  a: -76.63798,     b: 152.42795,   c: 367.99884 },
  { Pmin: 0.57026,  Pmax: 0.9322,   a: -29.90978,     b: 100.19602,   c: 382.58877 },
  { Pmin: 0.9322,   Pmax: 1.4551,   a: -12.82674,     b: 68.86951,    c: 396.94624 },
  { Pmin: 1.4551,   Pmax: 2.1831,   a: -5.96693,      b: 49.18143,    c: 411.06999 },
  { Pmin: 2.1831,   Pmax: 3.1655,   a: -2.97684,      b: 36.28023,    c: 424.98403 },
  { Pmin: 3.1655,   Pmax: 4.4569,   a: -1.57427,      b: 27.48678,    c: 438.76539 },
  { Pmin: 4.4569,   Pmax: 6.1172,   a: -0.87981,      b: 21.34922,    c: 452.32518 },
  { Pmin: 6.1172,   Pmax: 8.2132,   a: -0.51422,      b: 16.91093,    c: 465.79457 },
  { Pmin: 8.2132,   Pmax: 10.821,   a: -0.31258,      b: 13.61908,    c: 479.22960 },
  { Pmin: 10.821,   Pmax: 14.033,   a: -0.19848,      b: 11.15961,    c: 492.48242 },
  { Pmin: 14.033,   Pmax: 17.969,   a: -0.13154,      b: 9.29074,     c: 505.52590 },
  { Pmin: 17.969,   Pmax: 22.064,   a: -0.09982,      b: 8.17193,     c: 515.38910 }
];

export function Tsat(P) {
    
  if (P < P_TRIPLE || P > P_CRIT) return NaN;

  for (const seg of TsatPieces) {
    if (P >= seg.Pmin && P <= seg.Pmax) {
      return seg.a * P * P + seg.b * P + seg.c;
    }
  }

  return NaN;
}

/* ============================================================
   Psat(T) — piece-wise quadratic fit
   T in K → P in MPa
   ============================================================ */

const PsatPieces = [
  { Tmin: 273.16, Tmax: 290.0, a: 0.00000221167, b: -0.00116784925, c: 0.15459522618 },
  { Tmin: 290.0,  Tmax: 310.0, a: 0.00000538500, b: -0.00301545000, c: 0.42352200000 },
  { Tmin: 310.0,  Tmax: 330.0, a: 0.00001176000, b: -0.00697730000, c: 1.03905800000 },
  { Tmin: 330.0,  Tmax: 350.0, a: 0.00002259500, b: -0.01414115000, c: 2.22319700000 },
  { Tmin: 350.0,  Tmax: 370.0, a: 0.00003914500, b: -0.02574175000, c: 4.25603200000 },
  { Tmin: 370.0,  Tmax: 390.0, a: 0.00006237500, b: -0.04294975000, c: 7.44280500000 },
  { Tmin: 390.0,  Tmax: 410.0, a: 0.00009275000, b: -0.06665950000, c: 12.06957000000 },
  { Tmin: 410.0,  Tmax: 430.0, a: 0.00013055000, b: -0.09767150000, c: 18.43031000000 },
  { Tmin: 430.0,  Tmax: 450.0, a: 0.00017560000, b: -0.13643100000, c: 26.76715000000 },
  { Tmin: 450.0,  Tmax: 470.0, a: 0.00022750000, b: -0.18315500000, c: 37.28320000000 },
  { Tmin: 470.0,  Tmax: 490.0, a: 0.00028600000, b: -0.23816000000, c: 50.21290000000 },
  { Tmin: 490.0,  Tmax: 510.0, a: 0.00035100000, b: -0.30188000000, c: 65.82920000000 },
  { Tmin: 510.0,  Tmax: 530.0, a: 0.00042200000, b: -0.37431000000, c: 84.30140000000 },
  { Tmin: 530.0,  Tmax: 550.0, a: 0.00050150000, b: -0.45860500000, c: 106.64620000000 },
  { Tmin: 550.0,  Tmax: 570.0, a: 0.00059000000, b: -0.55600000000, c: 133.44220000000 },
  { Tmin: 570.0,  Tmax: 590.0, a: 0.00069100000, b: -0.67117000000, c: 166.27420000000 },
  { Tmin: 590.0,  Tmax: 610.0, a: 0.00082000000, b: -0.82340000000, c: 211.18500000000 },
  { Tmin: 610.0,  Tmax: 630.0, a: 0.00100000000, b: -1.04320000000, c: 278.28499999999 },
  { Tmin: 630.0,  Tmax: 647.1, a: 0.00139065975, b: -1.53653787991, c: 434.03501037804 }
];

export function Psat(T) {
    
  if (T < T_TRIPLE || T > T_CRIT) return NaN;

  for (const seg of PsatPieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      return seg.a * T * T + seg.b * T + seg.c;
    }
  }

  return NaN;
}


/* ============================================================
   Saturated liquid density rho_f(T)
   rho_f in kg/m^3, T in K
   ============================================================ */

const RhoF_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: -0.007145, b: 3.963003, c: 449.566226 },
  { Tmin: 290.0,  Tmax: 310.0, a: -0.004590, b: 2.483100, c: 663.840000 },
  { Tmin: 310.0,  Tmax: 330.0, a: -0.003330, b: 1.701900, c: 784.926000 },
  { Tmin: 330.0,  Tmax: 350.0, a: -0.002790, b: 1.345500, c: 843.732000 },
  { Tmin: 350.0,  Tmax: 370.0, a: -0.002340, b: 1.029600, c: 899.172000 },
  { Tmin: 370.0,  Tmax: 390.0, a: -0.002250, b: 0.962100, c: 911.826000 },
  { Tmin: 390.0,  Tmax: 410.0, a: -0.002070, b: 0.821700, c: 939.204000 },
  { Tmin: 410.0,  Tmax: 430.0, a: -0.002160, b: 0.894600, c: 924.444000 },
  { Tmin: 430.0,  Tmax: 450.0, a: -0.002340, b: 1.051200, c: 890.388000 },
  { Tmin: 450.0,  Tmax: 470.0, a: -0.002520, b: 1.218600, c: 851.508000 },
  { Tmin: 470.0,  Tmax: 490.0, a: -0.002700, b: 1.387800, c: 811.746000 },
  { Tmin: 490.0,  Tmax: 510.0, a: -0.003240, b: 1.918800, c: 681.210000 },
  { Tmin: 510.0,  Tmax: 530.0, a: -0.003870, b: 2.564100, c: 515.970000 },
  { Tmin: 530.0,  Tmax: 550.0, a: -0.004860, b: 3.614400, c: 237.402000 },
  { Tmin: 550.0,  Tmax: 570.0, a: -0.006570, b: 5.496300, c: -280.368000 },
  { Tmin: 570.0,  Tmax: 590.0, a: -0.009810, b: 9.193500, c: -1335.096000 },
  { Tmin: 590.0,  Tmax: 610.0, a: -0.017010, b: 17.707500, c: -3852.036000 },
  { Tmin: 610.0,  Tmax: 630.0, a: -0.044370, b: 51.201900, c: -14102.964000 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.946403, b: 1195.666342, c: -377098.561107 }
];

export function rho_f_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of RhoF_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const rho = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(rho, EPS); // safety near critical
    }
  }

  return NaN;
}

/* ============================================================
   Saturated liquid specific volume v_f(T)
   v_f in m^3/kg, T in K
   ============================================================ */

export function v_f_sat(T) {
  const rho = rho_f_sat(T);
  if (!isFinite(rho) || rho <= EPS) return NaN;

  return 1.0 / rho;
}

/* ============================================================
   Saturated liquid enthalpy h_f(T)
   h_f in kJ/kg, T in K
   ============================================================ */

const HF_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: 0.0000000, b: 4.2134420,  c: -1150.94320561 },
  { Tmin: 290.0,  Tmax: 310.0, a: -0.0001670, b: 4.2855560, c: -1158.00555600 },
  { Tmin: 310.0,  Tmax: 330.0, a: 0.0001670,  b: 4.0783330, c: -1125.80000000 },
  { Tmin: 330.0,  Tmax: 350.0, a: 0.0002780,  b: 4.0044440, c: -1113.51666700 },
  { Tmin: 350.0,  Tmax: 370.0, a: 0.0004720,  b: 3.8680560, c: -1089.60000000 },
  { Tmin: 370.0,  Tmax: 390.0, a: 0.0006940,  b: 3.7036110, c: -1059.17778000 },
  { Tmin: 390.0,  Tmax: 410.0, a: 0.0010560,  b: 3.4211110, c: -1003.92777800 },
  { Tmin: 410.0,  Tmax: 430.0, a: 0.0016670,  b: 2.9111110, c: -897.55555600 },
  { Tmin: 430.0,  Tmax: 450.0, a: 0.0019440,  b: 2.6583330, c: -840.22222200 },
  { Tmin: 450.0,  Tmax: 470.0, a: 0.0022220,  b: 2.4055560, c: -782.72222200 },
  { Tmin: 470.0,  Tmax: 490.0, a: 0.0025000,  b: 2.1527780, c: -725.27777800 },
  { Tmin: 490.0,  Tmax: 510.0, a: 0.0033330,  b: 1.3444440, c: -529.27777800 },
  { Tmin: 510.0,  Tmax: 530.0, a: 0.0044440,  b: 0.2222220, c: -245.94444400 },
  { Tmin: 530.0,  Tmax: 550.0, a: 0.0061110,  b: -1.5388890, c: 219.27777800 },
  { Tmin: 550.0,  Tmax: 570.0, a: 0.0088890,  b: -4.6000000, c: 1062.61111000 },
  { Tmin: 570.0,  Tmax: 590.0, a: 0.0130560,  b: -9.3638890, c: 2424.27777800 },
  { Tmin: 590.0,  Tmax: 610.0, a: 0.0227780,  b: -20.8666670, c: 5826.61111100 },
  { Tmin: 610.0,  Tmax: 630.0, a: 0.0577780,  b: -63.7111110, c: 18938.22222200 },
  { Tmin: 630.0,  Tmax: 647.1, a: 1.3489640,  b: -1702.0737810, c: 538634.70142500 }
];

export function h_f_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of HF_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      return seg.a * T * T + seg.b * T + seg.c;
    }
  }

  return NaN;
}

/* ============================================================
   Saturated liquid entropy s_f(T)
   s_f in kJ/(kg·K), T in K
   ============================================================ */

const SF_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: 0.00000000,  b: 0.01523717,  c: -4.16218536 },
  { Tmin: 290.0,  Tmax: 310.0, a: -0.00002389, b: 0.02828889,  c: -5.94322222 },
  { Tmin: 310.0,  Tmax: 330.0, a: -0.00001972, b: 0.02570278,  c: -5.54194444 },
  { Tmin: 330.0,  Tmax: 350.0, a: -0.00001722, b: 0.02404444,  c: -5.26694444 },
  { Tmin: 350.0,  Tmax: 370.0, a: -0.00001500, b: 0.02248333,  c: -4.99277778 },
  { Tmin: 370.0,  Tmax: 390.0, a: -0.00001306, b: 0.02104722,  c: -4.72761111 },
  { Tmin: 390.0,  Tmax: 410.0, a: -0.00001111, b: 0.01953333,  c: -4.43294444 },
  { Tmin: 410.0,  Tmax: 430.0, a: -0.00000944, b: 0.01816667,  c: -4.15277778 },
  { Tmin: 430.0,  Tmax: 450.0, a: -0.00000806, b: 0.01698056,  c: -3.89955556 },
  { Tmin: 450.0,  Tmax: 470.0, a: -0.00000611, b: 0.01523333,  c: -3.50705556 },
  { Tmin: 470.0,  Tmax: 490.0, a: -0.00000444, b: 0.01366111,  c: -3.13627778 },
  { Tmin: 490.0,  Tmax: 510.0, a: -0.00000278, b: 0.01201667,  c: -2.73066667 },
  { Tmin: 510.0,  Tmax: 530.0, a: -0.00000111, b: 0.01031667,  c: -2.29716667 },
  { Tmin: 530.0,  Tmax: 550.0, a:  0.00000167, b: 0.00737222,  c: -1.51688889 },
  { Tmin: 550.0,  Tmax: 570.0, a:  0.00000500, b: -0.00370556, c: -0.50855556 },
  { Tmin: 570.0,  Tmax: 590.0, a:  0.00001139, b: -0.00356944, c:  1.56244444 },
  { Tmin: 590.0,  Tmax: 610.0, a:  0.00002611, b: -0.02096667, c:  6.70200000 },
  { Tmin: 610.0,  Tmax: 630.0, a:  0.00007833, b: -0.08489444, c: 26.26605556 },
  { Tmin: 630.0,  Tmax: 647.1, a:  0.00206389, b: -2.60434913, c: 825.45577881 }
];

export function s_f_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of SF_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      return seg.a * T * T + seg.b * T + seg.c;
    }
  }

  return NaN;
}

/* ============================================================
   Saturated liquid heat capacity cp_f(T)
   cp_f in kJ/(kg·K), T in K
   ============================================================ */

const CPF_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: 0.00007613,  b: -0.04483314,  c: 10.78955590 },
  { Tmin: 290.0,  Tmax: 310.0, a: 0.00002306,  b: -0.01420833,  c: 6.37194444 },
  { Tmin: 310.0,  Tmax: 330.0, a: 0.00000917,  b: -0.00564722,  c: 5.05272222 },
  { Tmin: 330.0,  Tmax: 350.0, a: 0.00000778,  b: -0.00475000,  c: 4.90788889 },
  { Tmin: 350.0,  Tmax: 370.0, a: 0.00000944,  b: -0.00592222,  c: 5.11400000 },
  { Tmin: 370.0,  Tmax: 390.0, a: 0.00001222,  b: -0.00797222,  c: 5.49222222 },
  { Tmin: 390.0,  Tmax: 410.0, a: 0.00001528,  b: -0.01036389,  c: 5.96022222 },
  { Tmin: 410.0,  Tmax: 430.0, a: 0.00001833,  b: -0.01287778,  c: 6.47727778 },
  { Tmin: 430.0,  Tmax: 450.0, a: 0.00002222,  b: -0.01621667,  c: 7.19394444 },
  { Tmin: 450.0,  Tmax: 470.0, a: 0.00002889,  b: -0.02221667,  c: 8.54394444 },
  { Tmin: 470.0,  Tmax: 490.0, a: 0.00003861,  b: -0.03136944,  c: 10.69811111 },
  { Tmin: 490.0,  Tmax: 510.0, a: 0.00005417,  b: -0.04664722,  c: 14.44933333 },
  { Tmin: 510.0,  Tmax: 530.0, a: 0.00008056,  b: -0.07361111,  c: 21.33716667 },
  { Tmin: 530.0,  Tmax: 550.0, a: 0.00013083,  b: -0.12699167,  c: 35.50583333 },
  { Tmin: 550.0,  Tmax: 570.0, a: 0.00023861,  b: -0.24575833,  c: 68.22472222 },
  { Tmin: 570.0,  Tmax: 590.0, a: 0.00051111,  b: -0.55705556,  c: 157.12888889 },
  { Tmin: 590.0,  Tmax: 610.0, a: 0.00149722,  b: -1.72419444,  c: 502.47555556 },
  { Tmin: 610.0,  Tmax: 630.0, a: 0.00973333,  b: -11.81911111, c: 3595.71777778 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.29062168, b: 370.40219618, c: -117992.80229965 }
];

export function cp_f_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of CPF_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const cp = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(cp, EPS); // avoid negative Cp near critical
    }
  }

  return NaN;
}

/* ============================================================
   Saturated liquid heat capacity cv_f(T)
   cv_f in kJ/(kg·K), T in K
   ============================================================ */

const CVF_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: -0.00004033, b: 0.01979871,  c: 1.82199807 },
  { Tmin: 290.0,  Tmax: 310.0, a: -0.00002333, b: 0.00997222,  c: 3.24233333 },
  { Tmin: 310.0,  Tmax: 330.0, a: -0.00001389, b: 0.00411667,  c: 4.14994444 },
  { Tmin: 330.0,  Tmax: 350.0, a: -0.00000528, b: -0.00156944, c: 5.08861111 },
  { Tmin: 350.0,  Tmax: 370.0, a:  0.00000056, b: -0.00565000, c: 5.80222222 },
  { Tmin: 370.0,  Tmax: 390.0, a:  0.00000472, b: -0.00872500, c: 6.36955556 },
  { Tmin: 390.0,  Tmax: 410.0, a:  0.00000694, b: -0.01044722, c: 6.70322222 },
  { Tmin: 410.0,  Tmax: 430.0, a:  0.00000778, b: -0.01116667, c: 6.83761111 },
  { Tmin: 430.0,  Tmax: 450.0, a:  0.00000833, b: -0.01158333, c: 6.93555556 },
  { Tmin: 450.0,  Tmax: 470.0, a:  0.00000889, b: -0.01208333, c: 7.04805556 },
  { Tmin: 470.0,  Tmax: 490.0, a:  0.00000889, b: -0.01209444, c: 7.05327778 },
  { Tmin: 490.0,  Tmax: 510.0, a:  0.00000889, b: -0.01209444, c: 7.05327778 },
  { Tmin: 510.0,  Tmax: 530.0, a:  0.00001056, b: -0.01378889, c: 7.48394444 },
  { Tmin: 530.0,  Tmax: 550.0, a:  0.00001333, b: -0.01675000, c: 8.27305556 },
  { Tmin: 550.0,  Tmax: 570.0, a:  0.00001861, b: -0.02256389, c: 9.87416667 },
  { Tmin: 570.0,  Tmax: 590.0, a:  0.00003250, b: -0.03843056, c: 14.40566667 },
  { Tmin: 590.0,  Tmax: 610.0, a:  0.00007278, b: -0.08608333, c: 28.50011111 },
  { Tmin: 610.0,  Tmax: 630.0, a:  0.00033611, b: -0.40873889, c: 127.33366667 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.03159313, b: 40.15865585, c: -12757.41003027 }
];

export function cv_f_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of CVF_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const cv = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(cv, EPS); // keep Cv positive
    }
  }

  return NaN;
}

/* ============================================================
   Saturated liquid thermal conductivity k_f(T)
   k_f in W/(m·K), T in K
   ============================================================ */

const KF_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: -0.00000188, b: 0.00293808, c: -0.10157723 },
  { Tmin: 290.0,  Tmax: 310.0, a: -0.00000890, b: 0.00700600, c: -0.69052000 },
  { Tmin: 310.0,  Tmax: 330.0, a: -0.00001095, b: 0.00826450, c: -0.88365000 },
  { Tmin: 330.0,  Tmax: 350.0, a: -0.00000960, b: 0.00736900, c: -0.73515000 },
  { Tmin: 350.0,  Tmax: 370.0, a: -0.00000750, b: 0.00590100, c: -0.47860000 },
  { Tmin: 370.0,  Tmax: 390.0, a: -0.00000575, b: 0.00461050, c: -0.24069000 },
  { Tmin: 390.0,  Tmax: 410.0, a: -0.00000465, b: 0.00375450, c: -0.07416000 },
  { Tmin: 410.0,  Tmax: 430.0, a: -0.00000420, b: 0.00338700, c:  0.00087000 },
  { Tmin: 430.0,  Tmax: 450.0, a: -0.00000405, b: 0.00325850, c:  0.02839000 },
  { Tmin: 450.0,  Tmax: 470.0, a: -0.00000425, b: 0.00343650, c: -0.01121000 },
  { Tmin: 470.0,  Tmax: 490.0, a: -0.00000480, b: 0.00395500, c: -0.13341000 },
  { Tmin: 490.0,  Tmax: 510.0, a: -0.00000545, b: 0.00459450, c: -0.29070000 },
  { Tmin: 510.0,  Tmax: 530.0, a: -0.00000630, b: 0.00546200, c: -0.51204000 },
  { Tmin: 530.0,  Tmax: 550.0, a: -0.00000710, b: 0.00630800, c: -0.73570000 },
  { Tmin: 550.0,  Tmax: 570.0, a: -0.00000695, b: 0.00614050, c: -0.68895000 },
  { Tmin: 570.0,  Tmax: 590.0, a: -0.00000485, b: 0.00374350, c: -0.00495000 },
  { Tmin: 590.0,  Tmax: 610.0, a: -0.00000230, b: 0.00074000, c:  0.87946000 },
  { Tmin: 610.0,  Tmax: 630.0, a: -0.00000330, b: 0.00196600, c:  0.50370000 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.00331479, b: 4.20802055, c: -1334.98177061 }
];

export function k_f_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of KF_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const k = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(k, EPS); // keep conductivity positive
    }
  }

  return NaN;
}

/* ============================================================
   Saturated liquid dynamic viscosity mu_f(T)
   mu_f in Pa·s, T in K
   (correlation returns micro-Pa·s → converted to Pa·s)
   ============================================================ */

const MUF_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: -0.00714500, b: 3.96300300,  c: 449.56622600 },
  { Tmin: 290.0,  Tmax: 310.0, a: -0.00459000, b: 2.48310000,  c: 663.84000000 },
  { Tmin: 310.0,  Tmax: 330.0, a: -0.00333000, b: 1.70190000,  c: 784.92600000 },
  { Tmin: 330.0,  Tmax: 350.0, a: -0.00279000, b: 1.34550000,  c: 843.73200000 },
  { Tmin: 350.0,  Tmax: 370.0, a: -0.00234000, b: 1.02960000,  c: 899.17200000 },
  { Tmin: 370.0,  Tmax: 390.0, a: -0.00225000, b: 0.96210000,  c: 911.82600000 },
  { Tmin: 390.0,  Tmax: 410.0, a: -0.00207000, b: 0.82170000,  c: 939.20400000 },
  { Tmin: 410.0,  Tmax: 430.0, a: -0.00216000, b: 0.89460000,  c: 924.44400000 },
  { Tmin: 430.0,  Tmax: 450.0, a: -0.00234000, b: 1.05120000,  c: 890.38800000 },
  { Tmin: 450.0,  Tmax: 470.0, a: -0.00252000, b: 1.21860000,  c: 851.50800000 },
  { Tmin: 470.0,  Tmax: 490.0, a: -0.00270000, b: 1.38780000,  c: 811.74600000 },
  { Tmin: 490.0,  Tmax: 510.0, a: -0.00324000, b: 1.91880000,  c: 681.21000000 },
  { Tmin: 510.0,  Tmax: 530.0, a: -0.00387000, b: 2.56410000,  c: 515.97000000 },
  { Tmin: 530.0,  Tmax: 550.0, a: -0.00486000, b: 3.61440000,  c: 237.40200000 },
  { Tmin: 550.0,  Tmax: 570.0, a: -0.00657000, b: 5.49630000,  c: -280.36800000 },
  { Tmin: 570.0,  Tmax: 590.0, a: -0.00981000, b: 9.19350000,  c: -1335.09600000 },
  { Tmin: 590.0,  Tmax: 610.0, a: -0.01701000, b: 17.70750000, c: -3852.03600000 },
  { Tmin: 610.0,  Tmax: 630.0, a: -0.04437000, b: 51.20190000, c: -14102.96400000 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.94640300, b: 1195.66634200, c: -377098.56110700 }
];

export function mu_f_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of MUF_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const mu_micro = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(mu_micro * 1e-6, EPS); // convert to Pa·s
    }
  }

  return NaN;
}

/* ============================================================
   Saturated vapor density rho_g(T)
   rho_g in kg/m^3, T in K
   ============================================================ */

const RHOG_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a: 0.0000151213, b: -0.0079513211, c: 1.0485307308 },
  { Tmin: 290.0,  Tmax: 310.0, a: 0.0000342900, b: -0.0191097000, c: 2.6723700000 },
  { Tmin: 310.0,  Tmax: 330.0, a: 0.0000694800, b: -0.0409752000, c: 6.0689160000 },
  { Tmin: 330.0,  Tmax: 350.0, a: 0.0001251000, b: -0.0777384000, c: 12.1437540000 },
  { Tmin: 350.0,  Tmax: 370.0, a: 0.0002051100, b: -0.1338093000, c: 21.9673440000 },
  { Tmin: 370.0,  Tmax: 390.0, a: 0.0003121200, b: -0.2130696000, c: 36.6439860000 },
  { Tmin: 390.0,  Tmax: 410.0, a: 0.0004495500, b: -0.3203487000, c: 57.5797320000 },
  { Tmin: 410.0,  Tmax: 430.0, a: 0.0006201000, b: -0.4603050000, c: 86.2923600000 },
  { Tmin: 430.0,  Tmax: 450.0, a: 0.0008316000, b: -0.6422940000, c: 125.4412800000 },
  { Tmin: 450.0,  Tmax: 470.0, a: 0.0010962000, b: -0.8805780000, c: 179.0875800000 },
  { Tmin: 470.0,  Tmax: 490.0, a: 0.0014337000, b: -1.1980350000, c: 253.7386200000 },
  { Tmin: 490.0,  Tmax: 510.0, a: 0.0018828000, b: -1.6384860000, c: 361.7307000000 },
  { Tmin: 510.0,  Tmax: 530.0, a: 0.0025146000, b: -2.2835700000, c: 526.3923600000 },
  { Tmin: 530.0,  Tmax: 550.0, a: 0.0034560000, b: -3.2826600000, c: 791.4708000000 },
  { Tmin: 550.0,  Tmax: 570.0, a: 0.0050040000, b: -4.9876200000, c: 1260.9288000000 },
  { Tmin: 570.0,  Tmax: 590.0, a: 0.0079110000, b: -8.3065500000, c: 2208.2346000000 },
  { Tmin: 590.0,  Tmax: 610.0, a: 0.0146070000, b: -16.2231300000, c: 4548.1392000000 },
  { Tmin: 610.0,  Tmax: 630.0, a: 0.0379440000, b: -44.7789600000, c: 13283.4978000000 },
  { Tmin: 630.0,  Tmax: 647.1, a: 0.9332432913, b: -1180.7920599852, c: 373627.4620630070 }
];

export function rho_g_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of RHOG_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const rho = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(rho, EPS); // keep density positive
    }
  }

  return NaN;
}

/* ============================================================
   Saturated vapor specific volume v_g(T)
   v_g in m^3/kg, T in K
   ============================================================ */

export function v_g_sat(T) {
  const rho = rho_g_sat(T);
  if (!isFinite(rho) || rho <= EPS) return NaN;

  return 1.0 / rho;
}

/* ============================================================
   Saturated vapor enthalpy h_g(T)
   h_g in kJ/kg, T in K
   ============================================================ */

const HG_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a:  0.000017, b:   1.817881,  c:  2005.187676 },
  { Tmin: 290.0,  Tmax: 310.0, a: -0.000556, b:   2.144444,  c:  1958.666667 },
  { Tmin: 310.0,  Tmax: 330.0, a: -0.000833, b:   2.308333,  c:  1934.555556 },
  { Tmin: 330.0,  Tmax: 350.0, a: -0.001389, b:   2.663889,  c:  1877.722222 },
  { Tmin: 350.0,  Tmax: 370.0, a: -0.002222, b:   3.244444,  c:  1776.611111 },
  { Tmin: 370.0,  Tmax: 390.0, a: -0.002778, b:   3.650000,  c:  1702.611111 },
  { Tmin: 390.0,  Tmax: 410.0, a: -0.003611, b:   4.291667,  c:  1579.111111 },
  { Tmin: 410.0,  Tmax: 430.0, a: -0.004722, b:   5.197222,  c:  1394.611111 },
  { Tmin: 430.0,  Tmax: 450.0, a: -0.005278, b:   5.669444,  c:  1294.277778 },
  { Tmin: 450.0,  Tmax: 470.0, a: -0.006389, b:   6.658333,  c:  1074.277778 },
  { Tmin: 470.0,  Tmax: 490.0, a: -0.008056, b:   8.230556,  c:   703.500000 },
  { Tmin: 490.0,  Tmax: 510.0, a: -0.008889, b:   9.500000,  c:   502.055556 },
  { Tmin: 510.0,  Tmax: 530.0, a: -0.010833, b:  11.019444,  c:     3.388889 },
  { Tmin: 530.0,  Tmax: 550.0, a: -0.014167, b:  14.552778,  c:  -932.944444 },
  { Tmin: 550.0,  Tmax: 570.0, a: -0.018611, b:  19.452778,  c: -2283.500000 },
  { Tmin: 570.0,  Tmax: 590.0, a: -0.026667, b:  28.650000,  c: -4908.666667 },
  { Tmin: 590.0,  Tmax: 610.0, a: -0.044167, b:  49.352778,  c: -11031.555556 },
  { Tmin: 610.0,  Tmax: 630.0, a: -0.098889, b: 116.322222,  c: -31520.777778 },
  { Tmin: 630.0,  Tmax: 647.1, a: -1.889731, b: 2388.391510, c: -752139.255580 }
];

export function h_g_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of HG_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      return seg.a * T * T + seg.b * T + seg.c;
    }
  }

  return NaN;
}

/* ============================================================
   Saturated vapor entropy s_g(T)
   s_g in kJ/(kg·K), T in K
   ============================================================ */

const SG_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a:  0.00011493, b: -0.08956317, c:   25.05307236 },
  { Tmin: 290.0,  Tmax: 310.0, a:  0.00009444, b: -0.07777778, c:   23.35777778 },
  { Tmin: 310.0,  Tmax: 330.0, a:  0.00007222, b: -0.06405556, c:   21.23944444 },
  { Tmin: 330.0,  Tmax: 350.0, a:  0.00006111, b: -0.05677778, c:   20.04777778 },
  { Tmin: 350.0,  Tmax: 370.0, a:  0.00004444, b: -0.04516667, c:   18.02555556 },
  { Tmin: 370.0,  Tmax: 390.0, a:  0.00003611, b: -0.03891667, c:   16.85388889 },
  { Tmin: 390.0,  Tmax: 410.0, a:  0.00003056, b: -0.03463889, c:   16.03055556 },
  { Tmin: 410.0,  Tmax: 430.0, a:  0.00001944, b: -0.02547222, c:   14.14000000 },
  { Tmin: 430.0,  Tmax: 450.0, a:  0.00001944, b: -0.02547222, c:   14.14000000 },
  { Tmin: 450.0,  Tmax: 470.0, a:  0.00001667, b: -0.02311111, c:   13.64000000 },
  { Tmin: 470.0,  Tmax: 490.0, a:  0.00000833, b: -0.01536111, c:   11.83833333 },
  { Tmin: 490.0,  Tmax: 510.0, a:  0.00000278, b: -0.00991667, c:   10.50444444 },
  { Tmin: 510.0,  Tmax: 530.0, a: -0.00000278, b: -0.00413889, c:    9.00277778 },
  { Tmin: 530.0,  Tmax: 550.0, a: -0.00000278, b: -0.00413889, c:    9.00277778 },
  { Tmin: 550.0,  Tmax: 570.0, a: -0.00001389, b:  0.00802778, c:    5.67222222 },
  { Tmin: 570.0,  Tmax: 590.0, a: -0.00002778, b:  0.02394444, c:    1.11222222 },
  { Tmin: 590.0,  Tmax: 610.0, a: -0.00005139, b:  0.05193056, c:   -7.18055556 },
  { Tmin: 610.0,  Tmax: 630.0, a: -0.00013278, b:  0.15151667, c:  -37.64327778 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.00288300, b:  3.64082635, c: -1144.34527815 }
];

export function s_g_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of SG_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      return seg.a * T * T + seg.b * T + seg.c;
    }
  }

  return NaN;
}

/* ============================================================
   Saturated vapor heat capacity cp_g(T)
   cp_g in kJ/(kg·K), T in K
   ============================================================ */

const CPG_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a:  0.00000422, b: -0.00131054, c:   1.92910533 },
  { Tmin: 290.0,  Tmax: 310.0, a:  0.00000556, b: -0.00209444, c:   2.04405556 },
  { Tmin: 310.0,  Tmax: 330.0, a:  0.00001194, b: -0.00605833, c:   2.65888889 },
  { Tmin: 330.0,  Tmax: 350.0, a:  0.00002000, b: -0.01136667, c:   3.53338889 },
  { Tmin: 350.0,  Tmax: 370.0, a:  0.00002944, b: -0.01798333, c:   4.69227778 },
  { Tmin: 370.0,  Tmax: 390.0, a:  0.00004000, b: -0.02580556, c:   6.14144444 },
  { Tmin: 390.0,  Tmax: 410.0, a:  0.00005000, b: -0.03361111, c:   7.66461111 },
  { Tmin: 410.0,  Tmax: 430.0, a:  0.00005667, b: -0.03908333, c:   8.78755556 },
  { Tmin: 430.0,  Tmax: 450.0, a:  0.00006056, b: -0.04243333, c:   9.50900000 },
  { Tmin: 450.0,  Tmax: 470.0, a:  0.00006778, b: -0.04894444, c:  10.97650000 },
  { Tmin: 470.0,  Tmax: 490.0, a:  0.00008500, b: -0.06517222, c:  14.79916667 },
  { Tmin: 490.0,  Tmax: 510.0, a:  0.00012000, b: -0.09952778, c:  23.22988889 },
  { Tmin: 510.0,  Tmax: 530.0, a:  0.00018611, b: -0.16706111, c:  40.47638889 },
  { Tmin: 530.0,  Tmax: 550.0, a:  0.00031167, b: -0.30036111, c:  75.85683333 },
  { Tmin: 550.0,  Tmax: 570.0, a:  0.00057806, b: -0.59393056, c: 156.73738889 },
  { Tmin: 570.0,  Tmax: 590.0, a:  0.00125278, b: -1.36486111, c: 376.95055556 },
  { Tmin: 590.0,  Tmax: 610.0, a:  0.00360556, b: -4.14916667, c: 1200.68888889 },
  { Tmin: 610.0,  Tmax: 630.0, a:  0.02043611, b: -24.77313889, c: 7518.66222222 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.60866792, b: 776.00364786, c: -247279.32330450 }
];

export function cp_g_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of CPG_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const cp = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(cp, EPS); // Cp diverges near critical
    }
  }

  return NaN;
}

/* ============================================================
   Saturated vapor heat capacity cv_g(T)
   cv_g in kJ/(kg·K), T in K
   ============================================================ */

const CVG_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a:  0.00000229, b: -0.00042418, c:   1.36431881 },
  { Tmin: 290.0,  Tmax: 310.0, a:  0.00000278, b: -0.00071667, c:   1.40844444 },
  { Tmin: 310.0,  Tmax: 330.0, a:  0.00000722, b: -0.00348333, c:   1.83900000 },
  { Tmin: 330.0,  Tmax: 350.0, a:  0.00001222, b: -0.00678333, c:   2.38350000 },
  { Tmin: 350.0,  Tmax: 370.0, a:  0.00001750, b: -0.01047500, c:   3.02905556 },
  { Tmin: 370.0,  Tmax: 390.0, a:  0.00002306, b: -0.01457500, c:   3.78550000 },
  { Tmin: 390.0,  Tmax: 410.0, a:  0.00002694, b: -0.01759722, c:   4.37266667 },
  { Tmin: 410.0,  Tmax: 430.0, a:  0.00002667, b: -0.01735000, c:   4.31800000 },
  { Tmin: 430.0,  Tmax: 450.0, a:  0.00002250, b: -0.01375833, c:   3.54400000 },
  { Tmin: 450.0,  Tmax: 470.0, a:  0.00001694, b: -0.00875833, c:   2.41900000 },
  { Tmin: 470.0,  Tmax: 490.0, a:  0.00001389, b: -0.00588333, c:   1.74272222 },
  { Tmin: 490.0,  Tmax: 510.0, a:  0.00001500, b: -0.00697778, c:   2.01222222 },
  { Tmin: 510.0,  Tmax: 530.0, a:  0.00001944, b: -0.01153333, c:   3.17955556 },
  { Tmin: 530.0,  Tmax: 550.0, a:  0.00002583, b: -0.01831944, c:   4.98155556 },
  { Tmin: 550.0,  Tmax: 570.0, a:  0.00003556, b: -0.02902222, c:   7.92711111 },
  { Tmin: 570.0,  Tmax: 590.0, a:  0.00005083, b: -0.04645278, c:  12.89877778 },
  { Tmin: 590.0,  Tmax: 610.0, a:  0.00008722, b: -0.08947222, c:  25.61327778 },
  { Tmin: 610.0,  Tmax: 630.0, a:  0.00025056, b: -0.28948333, c:  86.84372222 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.03780798, b: 48.05564403, c: -15265.15254394 }
];

export function cv_g_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of CVG_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const cv = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(cv, EPS); // Cv diverges near critical
    }
  }

  return NaN;
}

/* ============================================================
   Saturated vapor thermal conductivity k_g(T)
   k_g in W/(m·K), T in K
   ============================================================ */

const KG_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a:  0.0000002767, b: -0.0000988395, c:  0.0234209616 },
  { Tmin: 290.0,  Tmax: 310.0, a:  0.0000002700, b: -0.0000951000, c:  0.0229030000 },
  { Tmin: 310.0,  Tmax: 330.0, a:  0.0000002850, b: -0.0001047500, c:  0.0244530000 },
  { Tmin: 330.0,  Tmax: 350.0, a:  0.0000003050, b: -0.0001181500, c:  0.0266970000 },
  { Tmin: 350.0,  Tmax: 370.0, a:  0.0000003350, b: -0.0001390500, c:  0.0303370000 },
  { Tmin: 370.0,  Tmax: 390.0, a:  0.0000003700, b: -0.0001650000, c:  0.0351470000 },
  { Tmin: 390.0,  Tmax: 410.0, a:  0.0000003950, b: -0.0001847500, c:  0.0390470000 },
  { Tmin: 410.0,  Tmax: 430.0, a:  0.0000004050, b: -0.0001932500, c:  0.0408510000 },
  { Tmin: 430.0,  Tmax: 450.0, a:  0.0000004100, b: -0.0001975000, c:  0.0417540000 },
  { Tmin: 450.0,  Tmax: 470.0, a:  0.0000004500, b: -0.0002336000, c:  0.0498990000 },
  { Tmin: 470.0,  Tmax: 490.0, a:  0.0000005200, b: -0.0002997000, c:  0.0655030000 },
  { Tmin: 490.0,  Tmax: 510.0, a:  0.0000006950, b: -0.0004716500, c:  0.1077410000 },
  { Tmin: 510.0,  Tmax: 530.0, a:  0.0000010750, b: -0.0008599500, c:  0.2069360000 },
  { Tmin: 530.0,  Tmax: 550.0, a:  0.0000019100, b: -0.0017465000, c:  0.4422560000 },
  { Tmin: 550.0,  Tmax: 570.0, a:  0.0000037750, b: -0.0038017500, c:  1.0084810000 },
  { Tmin: 570.0,  Tmax: 590.0, a:  0.0000082350, b: -0.0088962500, c:  2.4632920000 },
  { Tmin: 590.0,  Tmax: 610.0, a:  0.0000208700, b: -0.0238409000, c:  6.8823920000 },
  { Tmin: 610.0,  Tmax: 630.0, a:  0.0000764500, b: -0.0918845000, c: 27.7076700000 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.0025654781, b:  3.2668142276, c: -1039.6912528021 }
];

export function k_g_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of KG_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const k = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(k, EPS); // keep conductivity positive
    }
  }

  return NaN;
}

/* ============================================================
   Saturated vapor dynamic viscosity mu_g(T)
   mu_g in Pa·s, T in K
   (correlation returns micro-Pa·s → converted to Pa·s)
   ============================================================ */

const MUG_Pieces = [
  { Tmin: 273.16, Tmax: 290.0, a:  0.00010914, b: -0.03622101, c:   10.96663974 },
  { Tmin: 290.0,  Tmax: 310.0, a:  0.00007700, b: -0.01762000, c:    8.27550000 },
  { Tmin: 310.0,  Tmax: 330.0, a:  0.00005000, b: -0.00100000, c:    5.71800000 },
  { Tmin: 330.0,  Tmax: 350.0, a:  0.00003000, b:  0.01230000, c:    3.50700000 },
  { Tmin: 350.0,  Tmax: 370.0, a:  0.00001500, b:  0.02295000, c:    1.61700000 },
  { Tmin: 370.0,  Tmax: 390.0, a:  0.00001000, b:  0.02670000, c:    0.91400000 },
  { Tmin: 390.0,  Tmax: 410.0, a:  0.00001000, b:  0.02650000, c:    0.99200000 },
  { Tmin: 410.0,  Tmax: 430.0, a:  0.00000000, b:  0.03450000, c:   -0.60700000 },
  { Tmin: 430.0,  Tmax: 450.0, a: -0.00000500, b:  0.03885000, c:   -1.55300000 },
  { Tmin: 450.0,  Tmax: 470.0, a:  0.00000500, b:  0.02985000, c:    0.47200000 },
  { Tmin: 470.0,  Tmax: 490.0, a:  0.00001000, b:  0.02510000, c:    1.60000000 },
  { Tmin: 490.0,  Tmax: 510.0, a:  0.00002500, b:  0.01055000, c:    5.12800000 },
  { Tmin: 510.0,  Tmax: 530.0, a:  0.00006000, b: -0.02520000, c:   14.25700000 },
  { Tmin: 530.0,  Tmax: 550.0, a:  0.00010000, b: -0.06760000, c:   25.49300000 },
  { Tmin: 550.0,  Tmax: 570.0, a:  0.00019000, b: -0.16650000, c:   52.66300000 },
  { Tmin: 570.0,  Tmax: 590.0, a:  0.00037500, b: -0.37775000, c:  112.96900000 },
  { Tmin: 590.0,  Tmax: 610.0, a:  0.00081500, b: -0.89825000, c:  266.90000000 },
  { Tmin: 610.0,  Tmax: 630.0, a:  0.00249500, b: -2.95435000, c:  895.99300000 },
  { Tmin: 630.0,  Tmax: 647.1, a: -0.24718886, b: 314.22185751, c: -99825.49203706 }
];

export function mu_g_sat(T) {
  if (T < T_TRIPLE || T >= T_CRIT) return NaN;

  for (const seg of MUG_Pieces) {
    if (T >= seg.Tmin && T < seg.Tmax) {
      const mu_micro = seg.a * T * T + seg.b * T + seg.c;
      return Math.max(mu_micro * 1e-6, EPS); // convert to Pa·s
    }
  }

  return NaN;
}


/* ============================================================
   Region 4 unified export (solver compatibility)
   ============================================================ */

export function region4(T) {
  const P = Psat(T);

  return {
    region: 4,
    phase: "two_phase",

    T,
    P,

    // Saturated liquid properties
    rho_f: rho_f_sat(T),
    v_f: v_f_sat(T),
    h_f: h_f_sat(T),
    s_f: s_f_sat(T),
    cp_f: cp_f_sat(T),
    cv_f: cv_f_sat(T),
    k_f: k_f_sat(T),
    mu_f: mu_f_sat(T),

    // Saturated vapor properties
    rho_g: rho_g_sat(T),
    v_g: v_g_sat(T),
    h_g: h_g_sat(T),
    s_g: s_g_sat(T),
    cp_g: cp_g_sat(T),
    cv_g: cv_g_sat(T),
    k_g: k_g_sat(T),
    mu_g: mu_g_sat(T)
  };
}

